name: tests
on:
  pull_request:
    paths:
      - .github/**
      - agents/**
      # computer-use-demo/** - Uncomment when computer-use-demo is added
  push:
    branches:
      - main
    paths:
      - .github/**
      - agents/**
      # computer-use-demo/** - Uncomment when computer-use-demo is added

jobs:
  # ============================================================================
  # Agents (reasonable-mind governance framework)
  # ============================================================================
  ruff-agents:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/ruff-action@v1
        with:
          src: "agents"

  pytest-agents:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          cache: "pip"
          python-version: "3.12"
      - name: Install dependencies
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install pytest pytest-cov pytest-asyncio
          pip install -r agents/requirements.txt
      - name: Add venv to PATH
        run: echo "$PWD/.venv/bin" >> $GITHUB_PATH
      - name: Prepare junit directory
        run: mkdir -p junit
      - name: Run tests
        run: pytest agents/tests -v --junitxml=junit/agents-test-results.xml
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-agents
          path: junit/agents-test-results.xml

  # ============================================================================
  # Computer Use Demo (Anthropic Computer Use API)
  # ----------------------------------------------------------------------------
  # NOTE: These jobs are commented out. To enable:
  # 1. Copy computer-use-demo/ from claude-quickstarts repo
  # 2. Uncomment the jobs below and the paths above
  # ============================================================================
  
  # ruff-computer-use:
  #   runs-on: ubuntu-latest
  #   defaults:
  #     run:
  #       working-directory: computer-use-demo
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: astral-sh/ruff-action@v1
  #       with:
  #         src: "computer-use-demo"

  # pyright-computer-use:
  #   runs-on: ubuntu-latest
  #   defaults:
  #     run:
  #       working-directory: computer-use-demo
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/setup-python@v5
  #       with:
  #         cache: "pip"
  #         python-version: "3.11.6"
  #     - run: |
  #         python -m venv .venv
  #         source .venv/bin/activate
  #         pip install -r dev-requirements.txt
  #     - run: echo "$PWD/.venv/bin" >> $GITHUB_PATH
  #     - uses: jakebailey/pyright-action@v1
  #       with:
  #         working-directory: computer-use-demo

  # pytest-computer-use:
  #   runs-on: ubuntu-latest
  #   defaults:
  #     run:
  #       working-directory: computer-use-demo
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/setup-python@v5
  #       with:
  #         cache: "pip"
  #         python-version: "3.11.6"
  #     - run: |
  #         python -m venv .venv
  #         source .venv/bin/activate
  #         pip install -r dev-requirements.txt
  #     - run: echo "$PWD/.venv/bin" >> $GITHUB_PATH
  #     - run: pytest tests --junitxml=junit/test-results.xml --cov=computer_use_demo --cov-report=xml
  #     - name: Upload coverage to Codecov
  #       uses: codecov/codecov-action@v4
  #       with:
  #         files: ./computer-use-demo/coverage.xml
  #         flags: computer-use-demo
  #     - name: Upload test results
  #       uses: actions/upload-artifact@v4
  #       if: always()
  #       with:
  #         name: test-results-computer-use-demo
  #         path: computer-use-demo/junit/test-results.xml
